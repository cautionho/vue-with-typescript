(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-fc0c2f14"],{2123:function(t,e,i){"use strict";i.r(e);var r=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("Button",{attrs:{type:"primary"},on:{click:t.Trigger}},[t._v("拆分")]),i("Modal",{staticClass:"Split-Modal",attrs:{title:"拆分订单",width:920},on:{"on-cancel":t.CancelModal},model:{value:t.SplitModal,callback:function(e){t.SplitModal=e},expression:"SplitModal"}},[i("Row",[i("Col",{attrs:{span:"24"}},[i("Form",{ref:"ShipOrder",attrs:{model:t.ShipOrder,rules:t.OriShipOrderRules,"label-width":100,inline:"",onsubmit:"return false;"}},[i("Table",{staticClass:"P-MB-10",attrs:{columns:t.Cols,data:t.ShipOrder.Items,size:"small",stripe:""}}),i("FormItem",{staticClass:"P-W-300",attrs:{label:"发货仓：",prop:"ShipOrder.ShipWarehouseId"}},[i("Select",{attrs:{placeholder:"发货仓",options:t.WarehouseDrop,onChange:t.ChangeWarehouse.bind(this,1)},model:{value:t.ShipOrder.ShipOrder.ShipWarehouseId,callback:function(e){t.$set(t.ShipOrder.ShipOrder,"ShipWarehouseId",e)},expression:"ShipOrder.ShipOrder.ShipWarehouseId"}})],1),i("FormItem",{staticClass:"P-W-300",attrs:{label:"物流渠道：",prop:"ShipOrder.ShippingMethodId"}},[i("Select",{attrs:{placeholder:"物流渠道",options:t.MethodDrop,optionValKey:"Id",optionKey:"Name"},model:{value:t.ShipOrder.ShipOrder.ShippingMethodId,callback:function(e){t.$set(t.ShipOrder.ShipOrder,"ShippingMethodId",e)},expression:"ShipOrder.ShipOrder.ShippingMethodId"}})],1),i("FormItem",{staticClass:"P-W-200",attrs:{label:"限重：",prop:"ShipOrder.ShipFee"}},[t.SplitInfo.length?i("span",[t._v(t._s(t.ShipOrder.ShipOrder.ShipFee))]):i("InputNumber",{attrs:{min:0},model:{value:t.ShipOrder.ShipOrder.ShipFee,callback:function(e){t.$set(t.ShipOrder.ShipOrder,"ShipFee",e)},expression:"ShipOrder.ShipOrder.ShipFee"}}),t._v(" g ")],1),i("FormItem",{staticClass:"P-W-300",attrs:{label:"订单金额："}},[i("span",[t._v(t._s(t.ShipOrder.ShipOrder.PayPrice)+" "+t._s(t.ShipOrder.ShipOrder.PayCurrency))])]),i("FormItem",{staticClass:"P-W-300",attrs:{label:"订单重量："}},[i("span",[t._v(t._s(t.ShipOrder.ShipOrder.Weight)+" g")])]),i("FormItem",{staticClass:"P-W-200",attrs:{label:""}},[i("Button",{attrs:{type:"primary"},on:{click:t.AutoSplit}},[t._v("一键拆分")])],1)],1)],1),t._l(t.SplitInfo,(function(e,r){return i("Col",{key:r,staticClass:"Split-Modules",attrs:{span:"24"}},[i("h4",{staticClass:"P-TA-C P-MB-10"},[t._v("拆分订单"+t._s(r+1)+t._s(0===r?"（原始订单保留）":"（新单）"))]),i("Form",{ref:"SplitInfo"+r,refInFor:!0,attrs:{model:e,rules:t.SplitRules,"label-width":100,inline:"",onsubmit:"return false;"}},[i("Table",{staticClass:"P-MB-10",attrs:{columns:t.SplitCols,data:e.ItemList,size:"small",stripe:""}}),i("FormItem",{staticClass:"P-W-300",attrs:{label:"发货仓：",prop:"ShipWarehouseId"}},[i("Select",{attrs:{placeholder:"发货仓",options:t.WarehouseDrop,onChange:t.ChangeWarehouse.bind(this,2,r)},model:{value:e.ShipWarehouseId,callback:function(i){t.$set(e,"ShipWarehouseId",i)},expression:"Item.ShipWarehouseId"}})],1),i("FormItem",{staticClass:"P-W-300",attrs:{label:"物流渠道：",prop:"ShippingMethodId"}},[i("Select",{attrs:{placeholder:"物流渠道",options:e.MethodDrop,optionValKey:"Id",optionKey:"Name"},model:{value:e.ShippingMethodId,callback:function(i){t.$set(e,"ShippingMethodId",i)},expression:"Item.ShippingMethodId"}})],1),i("FormItem",{staticClass:"P-W-200",attrs:{label:"限重："}},[t._v(" "+t._s(t.ShipOrder.ShipOrder.ShipFee)+" g ")]),i("FormItem",{staticClass:"P-W-300",attrs:{label:"订单金额："}},[i("InputNumber",{attrs:{min:0},model:{value:e.Amount,callback:function(i){t.$set(e,"Amount",i)},expression:"Item.Amount"}}),t._v(" "+t._s(t.ShipOrder.ShipOrder.PayCurrency)+" ")],1),i("FormItem",{staticClass:"P-W-300",attrs:{label:"订单重量："}},[i("span",[t._v(t._s(e.GrossWeight)+" g")])]),i("FormItem",{staticClass:"P-W-200",attrs:{label:"是否缺货："}},[i("span",[t._v(t._s(e.IsStockOut?"是":"否"))])])],1),e.IsAuto?t._e():i("div",{staticClass:"P-TA-R"},[i("Button",{attrs:{type:"error"},on:{click:function(e){return t.DelSplit(r)}}},[t._v("删除")])],1)],1)})),i("Col",{staticClass:"P-TA-R",attrs:{span:"24"}},[i("Button",{attrs:{type:"primary"},on:{click:t.AddSplit}},[t._v("添加拆分订单")])],1)],2),i("footer",{attrs:{slot:"footer"},slot:"footer"},[i("Button",{attrs:{type:"primary"},on:{click:t.ReCalculateAmount}},[t._v("重算订单金额")]),i("Button",{attrs:{type:"primary"},on:{click:t.Post}},[t._v("提交")]),i("Button",{on:{click:t.CancelModal}},[t._v("取消")])],1)],1)],1)},a=[],s=(i("d9b9"),i("6412"),i("9660"),i("cee1"),i("e8f2"),i("ef8f"),i("6bf8"),i("522a"),i("0b78"),i("52af"),i("e24e")),o=(i("b449"),i("5d83")),n=i("3231"),l=i("064d"),h=i("46d7"),p=i("631e"),d=i("4a81"),u=i("d11d"),S=i("1459"),c=function(t){Object(h["a"])(i,t);var e=Object(p["a"])(i);function i(){var t;return Object(n["a"])(this,i),t=e.apply(this,arguments),t.SplitModal=!1,t.WarehouseDrop=[],t.MethodDrop=[],t.ShipOrder=new S["a"].ShipOrderInfo,t.SplitInfo=[],t.OriShipOrderRules={"ShipOrder.ShipWarehouseId":[{required:!0,message:"请选择发货仓",trigger:"change",type:"number"},{pattern:t.$Pattern.PositiveNotZeroInt,message:"请选择发货仓"}],"ShipOrder.ShippingMethodId":[{required:!0,message:"请选择物流渠道",trigger:"change",type:"number"},{pattern:t.$Pattern.PositiveNotZeroInt,message:"请选择物流渠道"}],"ShipOrder.ShipFee":[{required:!0,message:"请输入限重"},{pattern:t.$Pattern.PositiveNotZeroInt,message:"请输入限重"}]},t.SplitRules={ShipWarehouseId:[{required:!0,message:"请选择发货仓",trigger:"change",type:"number"},{pattern:t.$Pattern.PositiveNotZeroInt,message:"请选择发货仓"}],ShippingMethodId:[{required:!0,message:"请选择物流渠道",trigger:"change",type:"number"},{pattern:t.$Pattern.PositiveNotZeroInt,message:"请选择物流渠道"}],Amount:[{required:!0,message:"请输入金额"}]},t.Cols=[{title:"SKU编号",key:"SkuCode",width:130},{title:"产品名称",key:"SkuName",render:function(t,e){return t("Tooltip",{class:"P-LINE-1",props:{content:e.row.Sku.SkuName}},e.row.Sku.SkuName)}},{title:"可用库存",key:"UsableQuantity",width:100},{title:"单品重量",width:100,render:function(t,e){return t("span","".concat(e.row.Sku.GrossWeight,"g"))}},{title:"购买数量",key:"Quantity",width:100}],t.SplitCols=[{title:"SKU编号",key:"SkuCode",width:130},{title:"产品名称",key:"SkuName",render:function(t,e){return t("Tooltip",{class:"P-LINE-1",props:{content:e.row.SkuName}},e.row.SkuName)}},{title:"可用库存",key:"AvailableQty",width:100},{title:"单品重量",width:100,render:function(t,e){return t("span","".concat(e.row.SingleWeight,"g"))}},{title:"分配数量",key:"AllotQty",width:100,render:function(e,i){return e("InputNumber",{attrs:{value:i.row.AllotQty,min:0},on:{"on-change":function(e){console.log(i),t.ChangeAllotQty(e,i.row)}}})}}],t}return Object(l["a"])(i,[{key:"TriggerOperations",value:function(t){}},{key:"EmitOperateSuccess",value:function(){}},{key:"Trigger",value:function(){this.TriggerOperations("SplitShipOrder")}},{key:"Validate",value:function(){var t=Object(o["a"])(regeneratorRuntime.mark((function t(e){var i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return this.$set(this,"ShipOrder",e[0]),t.next=3,this.GetShipOrderItems();case 3:if(i=t.sent,!i){t.next=19;break}if(this.$set(this,"SplitModal",!0),this.WarehouseDrop.length){t.next=13;break}return t.t0=this,t.t1=this,t.next=11,this.GetDropList(this.$Server.Settings,this.$Api.GetWarehouseDropList,!0);case 11:t.t2=t.sent,t.t0.$set.call(t.t0,t.t1,"WarehouseDrop",t.t2);case 13:return t.t3=this,t.t4=this,t.next=17,this.GetDropList(this.$Server.Logistics,this.$Api.ChannelDropList,this.ShipOrder.ShipOrder.ShipWarehouseId);case 17:t.t5=t.sent,t.t3.$set.call(t.t3,t.t4,"MethodDrop",t.t5);case 19:case"end":return t.stop()}}),t,this)})));function e(e){return t.apply(this,arguments)}return e}()},{key:"GetShipOrderItems",value:function(){var t=this;return new Promise((function(e){t.$UI.Loading.Show(),t.$Request.Post({Server:t.$Server.Warehouse,Api:{Address:t.$Api.GetShipOrderInfo,Login:!0},Data:{OrderId:t.ShipOrder.ShipOrder.Id,OrderCode:"",IsSplitSign:!0},Callback:function(i){if(t.$UI.Loading.Hide(),i.IsSuccess){if(!i.Data.ShipOrder.Weight){var r,a=Object(s["a"])(i.Data.Items);try{for(a.s();!(r=a.n()).done;){var o=r.value;i.Data.ShipOrder.Weight+=o.Sku.GrossWeight*o.Quantity}}catch(n){a.e(n)}finally{a.f()}}i.Data.ShipOrder.Weight=Number(i.Data.ShipOrder.Weight.toFixed(2)),i.Data.ShipOrder.ShipFee=2e3,t.$set(t,"ShipOrder",i.Data)}else t.$Request.Error(i);e(i.IsSuccess)}})}))}},{key:"GetDropList",value:function(t,e,i){var r=this;return new Promise((function(a){r.$Request.Post({Server:t,Api:{Address:e},Data:i,Callback:function(t){t.IsSuccess||r.$Request.Error(t),a(t.Data.DropList||[])}})}))}},{key:"ChangeWarehouse",value:function(t,e){var i=this;1===t?(this.ShipOrder.ShipOrder.ShippingMethodId=0,this.ShipOrder.ShipOrder.ShipWarehouseId&&this.GetDropList(this.$Server.Logistics,this.$Api.ChannelDropList,this.ShipOrder.ShipOrder.ShipWarehouseId).then((function(t){i.$set(i,"MethodDrop",t)}))):(this.SplitInfo[e].ShippingMethodId=0,this.SplitInfo[e].ShipWarehouseId&&this.GetDropList(this.$Server.Logistics,this.$Api.ChannelDropList,this.SplitInfo[e].ShipWarehouseId).then((function(t){i.$set(i.SplitInfo[e],"MethodDrop",t)})))}},{key:"ValidateMinLimit",value:function(){var t,e=[],i=Object(s["a"])(this.ShipOrder.Items);try{for(i.s();!(t=i.n()).done;){var r=t.value;e.push(r.Sku.GrossWeight)}}catch(o){i.e(o)}finally{i.f()}var a=Math.max.apply(Math,e);return a<=this.ShipOrder.ShipOrder.ShipFee||(this.$UI.Tips.Floating("warning","限制重量必须大于单品重量"),!1)}},{key:"AutoSplit",value:function(){var t=this;this.$refs.ShipOrder.validate((function(e){e&&t.ValidateMinLimit()&&(t.$UI.Loading.Show(),t.$Request.Post({Server:t.$Server.Warehouse,Api:{Address:t.$Api.GetWaitSplitOrderDetail,Login:!0},Data:{OrderId:t.ShipOrder.ShipOrder.Id,ShipWarehouseId:t.ShipOrder.ShipOrder.ShipWarehouseId,ShippingMethodId:t.ShipOrder.ShipOrder.ShippingMethodId,LimitWeight:t.ShipOrder.ShipOrder.ShipFee},Callback:function(e){t.$UI.Loading.Hide(),e.IsSuccess?(e.Data.Data.forEach((function(e,i){e["MethodDrop"]=t.MethodDrop,e["IsAuto"]=!0;var r,a=Object(s["a"])(e.ItemList);try{for(a.s();!(r=a.n()).done;){var o=r.value;o["SplitNum"]=i}}catch(n){a.e(n)}finally{a.f()}})),t.$set(t,"SplitInfo",e.Data.Data)):t.$Request.Error(e)}}))}))}},{key:"AddSplit",value:function(){if(this.ValidateMinLimit()){var t=new S["a"].Split;t.OrderId="".concat(String(this.ShipOrder.ShipOrder.Id),"_").concat(String(this.SplitInfo.length+1)),t.ShipWarehouseId=this.ShipOrder.ShipOrder.ShipWarehouseId,t.ShippingMethodId=this.ShipOrder.ShipOrder.ShippingMethodId,t.MethodDrop=this.MethodDrop;var e,i=Object(s["a"])(this.ShipOrder.Items);try{for(i.s();!(e=i.n()).done;){var r=e.value;t.ItemList.push({SkuId:r.Sku.Id,SkuCode:r.SkuCode,AvailableQty:r.UsableQuantity,SingleWeight:r.Sku.GrossWeight,AllotQty:0,SkuName:r.Sku.SkuName,SplitNum:this.SplitInfo.length})}}catch(a){i.e(a)}finally{i.f()}this.SplitInfo.push(t)}}},{key:"DelSplit",value:function(t){this.SplitInfo.splice(t,1)}},{key:"ChangeAllotQty",value:function(t,e){this.SplitInfo[e.SplitNum].ItemList[e._index].AllotQty=t;var i,r=0,a=Object(s["a"])(this.SplitInfo[e.SplitNum].ItemList);try{for(a.s();!(i=a.n()).done;){var o=i.value;r+=o.AllotQty*o.SingleWeight}}catch(n){a.e(n)}finally{a.f()}this.SplitInfo[e.SplitNum].GrossWeight=Number(r.toFixed(2)),this.CalculateOutStock()}},{key:"CalculateOutStock",value:function(){var t,e=this,i=[],r=Object(s["a"])(this.SplitInfo);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=!1;a.ItemList.forEach((function(t,r){var a=e.ShipOrder.Items[r].UsableQuantity;i[r]=i[r]?i[r]+t.AllotQty:t.AllotQty,t.AllotQty>0&&i[r]>a&&(o=!0)})),a.IsStockOut=o}}catch(n){r.e(n)}finally{r.f()}}},{key:"ReCalculateAmount",value:function(){var t,e=this,i=0,r=!0,a=0,o=Object(s["a"])(this.ShipOrder.Items);try{for(o.s();!(t=o.n()).done;){var n=t.value;i+=n.Quantity*n.Sku.AvgPrice}}catch(l){o.e(l)}finally{o.f()}r=!!i,this.SplitInfo.forEach((function(t,s){t.Amount=0,t.ItemList.forEach((function(a,s){var o=a.AllotQty*(r?e.ShipOrder.Items[s].Sku.AvgPrice:e.ShipOrder.Items[s].PayAmount);t.Amount+=Number((r?o/i*e.ShipOrder.ShipOrder.PayPrice:o).toFixed(3))})),s<e.SplitInfo.length-1?a+=t.Amount:t.Amount=Number((e.ShipOrder.ShipOrder.PayPrice-a).toFixed(3))}))}},{key:"ValidateAllotQty",value:function(){var t,e=this,i=[],r=0,a=!0,o=Object(s["a"])(this.SplitInfo);try{for(o.s();!(t=o.n()).done;){var n=t.value;n.ItemList.forEach((function(t,e){i[e]=i[e]?i[e]+t.AllotQty:t.AllotQty})),r+=n.Amount}}catch(l){o.e(l)}finally{o.f()}return this.ShipOrder.Items.forEach((function(t,r){if(t.Quantity!==i[r])return e.$UI.Tips.Floating("warning","拆分订单的分配数量之和不等于原单明细数量"),a=!1,!1})),r.toFixed(3)!==this.ShipOrder.ShipOrder.PayPrice.toFixed(3)?(this.$UI.Tips.Floating("warning","拆分订单的金额之和不等于原单金额"),a=!1,!1):a}},{key:"GetPostSplitData",value:function(){var t,e=JSON.parse(JSON.stringify(this.SplitInfo)),i=Object(s["a"])(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;delete r.MethodDrop,delete r.IsAuto;var a,o=Object(s["a"])(r.ItemList);try{for(o.s();!(a=o.n()).done;){var n=a.value;delete n.SplitNum}}catch(l){o.e(l)}finally{o.f()}}}catch(l){i.e(l)}finally{i.f()}return e}},{key:"Post",value:function(){var t=this;this.$refs.ShipOrder.validate((function(e){if(e){var i=[];t.SplitInfo.forEach((function(e,r){i.push(new Promise((function(e){t.$refs["SplitInfo".concat(r)][0].validate((function(t){e(t||!1)}))})))})),Promise.all(i).then((function(e){e.every((function(t){return t}))?t.ValidateAllotQty()&&t.PostSplit():t.$UI.Tips.Floating("warning","请完善拆分订单信息")}))}else t.$UI.Tips.Floating("warning","请完善原始订单信息")}))}},{key:"PostSplit",value:function(){var t=this;this.$UI.Loading.Show(),this.$Request.Post({Server:this.$Server.Warehouse,Api:{Address:this.$Api.CreatSplitOrder,Login:!0},Data:this.GetPostSplitData(),Callback:function(e){e.IsSuccess?(t.$UI.Tips.Floating("success","拆分订单成功"),t.EmitOperateSuccess(),t.CancelModal()):(t.$UI.Loading.Hide(),t.$Request.Error(e))}})}},{key:"CancelModal",value:function(){this.$set(this,"SplitModal",!1),this.$set(this,"ShipOrder",new S["a"].ShipOrderInfo),this.$set(this,"SplitInfo",[]),this.$set(this,"MethodDrop",[])}}]),i}(u["d"]);d["a"]([Object(u["b"])()],c.prototype,"TriggerOperations",null),d["a"]([Object(u["b"])()],c.prototype,"EmitOperateSuccess",null),c=d["a"]([Object(u["a"])({name:"SplitOrder"})],c);var f=c,I=f,m=(i("30c7"),i("4023")),O=Object(m["a"])(I,r,a,!1,null,null,null);e["default"]=O.exports},"30c7":function(t,e,i){"use strict";var r=i("6158"),a=i.n(r);a.a},6158:function(t,e,i){}}]);